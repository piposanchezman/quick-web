---
import LanguageSelector from "../ui/LanguageSelector.astro";
import ExternalLink from "../ui/ExternalLink.astro";
import { NAV_ITEMS, SOCIAL_LINKS } from "../../constants";
---

<nav
    id="navbar"
    class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 bg-transparent"
    role="navigation"
    aria-label="Navegación principal"
>
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <!-- Logo -->
        <a href="#inicio" class="flex items-center space-x-2 group" aria-label="Ir al inicio">
            <img
                src="/logo.webp"
                alt="QuickLand Logo"
                class="w-10 h-10 rounded-full border-2 border-[#55ffff] group-hover:scale-110 transition-transform duration-300"
                loading="eager"
                decoding="async"
                width="40"
                height="40"
            />
            <span class="text-xl font-bold text-white hidden sm:block">QuickLand</span>
        </a>

        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-6">
            {NAV_ITEMS.map(({ href, labelKey, label }) => (
                <a
                    href={href}
                    class="nav-link text-gray-300 hover:text-[#55ffff] transition-colors duration-300 font-medium"
                    data-i18n={labelKey}
                >
                    {label}
                </a>
            ))}
            <ExternalLink
                href={SOCIAL_LINKS.discord}
                class="px-4 py-2 bg-[#7289DA] text-white rounded-full font-semibold hover:bg-[#5865F2] hover:scale-105 transition-all duration-300"
                ariaLabel="Únete a nuestro servidor de Discord"
            >
                Discord
            </ExternalLink>
            <LanguageSelector />
        </div>

        <!-- Mobile Menu Button -->
        <button
            id="mobile-menu-btn"
            class="md:hidden text-white p-2 rounded-lg hover:bg-white/10 transition-colors"
            aria-label="Abrir menú de navegación"
            aria-expanded="false"
            aria-controls="mobile-menu"
        >
            <svg
                id="menu-icon"
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"
                />
            </svg>
            <svg
                id="close-icon"
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                />
            </svg>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div
        id="mobile-menu"
        class="md:hidden hidden bg-black/95 backdrop-blur-md border-t border-gray-800"
        role="menu"
    >
        <nav class="px-4 py-4 space-y-3">
            {NAV_ITEMS.map(({ href, labelKey, label }) => (
                <a
                    href={href}
                    class="mobile-nav-link block text-gray-300 hover:text-[#55ffff] transition-colors py-2 font-medium"
                    data-i18n={labelKey}
                    role="menuitem"
                >
                    {label}
                </a>
            ))}
            <ExternalLink
                href={SOCIAL_LINKS.discord}
                class="block text-center px-4 py-3 bg-[#7289DA] text-white rounded-lg font-semibold hover:bg-[#5865F2] transition-colors mt-4"
                ariaLabel="Unirse al servidor de Discord"
            >
                Unirse a Discord
            </ExternalLink>
        </nav>
    </div>
</nav>

<style>
    #navbar.scrolled {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(85, 255, 255, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .nav-link {
        position: relative;
    }

    .nav-link::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #55ffff, #33cccc);
        transition: width 0.3s ease;
    }

    .nav-link:hover::after {
        width: 100%;
    }

    .nav-link.active {
        color: #55ffff;
    }

    .nav-link.active::after {
        width: 100%;
    }
</style>

<script>
    // Navbar functionality with proper TypeScript support
    document.addEventListener("DOMContentLoaded", () => {
        const navbar = document.getElementById("navbar");
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");
        const menuIcon = document.getElementById("menu-icon");
        const closeIcon = document.getElementById("close-icon");
        const navLinks = document.querySelectorAll<HTMLAnchorElement>(".nav-link");
        const mobileNavLinks = document.querySelectorAll<HTMLAnchorElement>(".mobile-nav-link");

        // Handle scroll for navbar background and active links
        const handleScroll = (): void => {
            if (!navbar) return;

            // Toggle navbar scrolled state
            navbar.classList.toggle("scrolled", window.scrollY > 50);

            // Update active link based on current section
            const sections = document.querySelectorAll<HTMLElement>('section[id]');
            let currentSection = "inicio"; // Default to inicio

            // Calculate which section is currently in view
            const scrollPosition = window.scrollY + 150; // Offset for navbar height

            sections.forEach((section) => {
                const sectionTop = section.offsetTop;
                const sectionBottom = sectionTop + section.offsetHeight;
                
                if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                    currentSection = section.id;
                }
            });

            // Update active state for all nav links
            navLinks.forEach((link) => {
                const href = link.getAttribute("href");
                const isActive = href === `#${currentSection}`;
                link.classList.toggle("active", isActive);
            });
        };

        // Toggle mobile menu
        const toggleMobileMenu = (): void => {
            const isHidden = mobileMenu?.classList.toggle("hidden");
            menuIcon?.classList.toggle("hidden");
            closeIcon?.classList.toggle("hidden");
            mobileMenuBtn?.setAttribute("aria-expanded", isHidden ? "false" : "true");
        };

        // Close mobile menu
        const closeMobileMenu = (): void => {
            mobileMenu?.classList.add("hidden");
            menuIcon?.classList.remove("hidden");
            closeIcon?.classList.add("hidden");
            mobileMenuBtn?.setAttribute("aria-expanded", "false");
        };

        // Event listeners
        window.addEventListener("scroll", handleScroll, { passive: true });
        mobileMenuBtn?.addEventListener("click", toggleMobileMenu);
        mobileNavLinks.forEach((link) => {
            link.addEventListener("click", closeMobileMenu);
        });

        // Initial call to set active link on page load
        handleScroll();
    });
</script>
